<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joy's Territory</title>
    <!-- KaTeX for mathematical equations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        /* Your existing CSS remains the same */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #ff9e00;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: white;
            box-shadow: var(--shadow);
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .auth-section {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--secondary);
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #3aa8d0;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #e11570;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background-color: #e68a00;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .question-container {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            font-weight: bold;
            font-size: 18px;
        }

        .question-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .type-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
        }

        .type-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            margin-bottom: 15px;
            border-radius: var(--border-radius);
        }

        .option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .option input[type="text"] {
            flex: 1;
            margin-right: 10px;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .exam-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .exam-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.3s ease;
        }

        .exam-card:hover {
            transform: translateY(-5px);
        }

        .exam-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .exam-info {
            color: var(--gray);
            margin-bottom: 15px;
        }

        .exam-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .student-answer {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
        }

        .correct-answer {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .incorrect-answer {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .result-summary {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            background-color: #e9ecef;
        }

        .score {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            font-weight: bold;
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--warning);
            color: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            font-weight: bold;
            font-size: 18px;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .timer.warning {
            background-color: var(--danger);
            animation: pulse 1s infinite;
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 15px;
        }

        .student-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .student-credentials {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .confirmation-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            z-index: 1001;
            border: 2px solid var(--success);
        }

        .confirmation-message .tick {
            font-size: 48px;
            color: var(--success);
            margin-bottom: 15px;
        }

        .confirmation-message h3 {
            margin-bottom: 15px;
            color: var(--success);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Math equation styling */
        .math-equation {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border-left: 4px solid var(--primary);
        }

        .katex-display {
            margin: 10px 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .math-preview {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border: 1px solid #ddd;
        }

        .math-help {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            font-size: 14px;
        }

        .math-help ul {
            margin-left: 20px;
        }

        .math-help li {
            margin-bottom: 5px;
        }

        /* NEW STYLES FOR ENHANCEMENTS */
        .question-category {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
        }

        .category-btn.active {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }

        .students-multiselect {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 10px;
            margin-top: 10px;
        }

        .student-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .student-checkbox input {
            margin-right: 10px;
        }

        .cq-answer-container {
            margin-top: 10px;
        }

        .cq-answer-container textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .exam-list {
                grid-template-columns: 1fr;
            }

            .tab-container {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }

            .question-type {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">Joy's Territory</div>
                <div class="user-info">
                    <span id="currentUserName" class="hidden"></span>
                    <div class="auth-section">
                        <button id="adminLoginBtn" class="btn btn-primary">Admin Login</button>
                        <button id="studentLoginBtn" class="btn btn-secondary">Student Login</button>
                        <button id="logoutBtn" class="btn btn-danger hidden">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Login Forms -->
        <div id="adminLoginForm" class="card hidden">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="adminUsername">Username</label>
                <input type="text" id="adminUsername" placeholder="Enter admin username">
            </div>
            <div class="form-group">
                <label for="adminPassword">Password</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button id="adminLoginSubmit" class="btn btn-primary">Login</button>
        </div>

        <div id="studentLoginForm" class="card hidden">
            <h2>Student Login</h2>
            <div class="form-group">
                <label for="studentUsername">Username</label>
                <input type="text" id="studentUsername" placeholder="Enter student username">
            </div>
            <div class="form-group">
                <label for="studentPassword">Password</label>
                <input type="password" id="studentPassword" placeholder="Enter student password">
            </div>
            <button id="studentLoginSubmit" class="btn btn-primary">Login</button>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <div class="tab-container">
                <div class="tab active" data-tab="createExam">Create Exam</div>
                <div class="tab" data-tab="addStudent">Add Student</div>
                <div class="tab" data-tab="examList">My Exams</div>
                <div class="tab" data-tab="deleteResults">Delete Results</div>
            </div>

            <!-- Create Exam Tab -->
            <div id="createExam" class="tab-content">
                <div class="card">
                    <h2>Create New MCQ Exam</h2>
                    <div class="form-group">
                        <label for="examTitle">Exam Title</label>
                        <input type="text" id="examTitle" placeholder="Enter exam title">
                    </div>
                    <div class="form-group">
                        <label for="examDescription">Exam Description</label>
                        <textarea id="examDescription" placeholder="Enter exam description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="examTimeLimit">Time Limit (minutes)</label>
                        <input type="number" id="examTimeLimit" placeholder="Enter time limit in minutes" min="1" value="30">
                    </div>
                    <div class="form-group">
                        <label>Assign to Students</label>
                        <div class="students-multiselect" id="studentsForExam">
                            <!-- Students checkboxes will be added here -->
                        </div>
                    </div>
                </div>

                <div id="questionsContainer">
                    <!-- Questions will be added here dynamically -->
                </div>

                <div class="actions">
                    <button id="addQuestionBtn" class="btn btn-primary">Add Question</button>
                    <button id="finishExamBtn" class="btn btn-success">Finish Exam</button>
                </div>
            </div>

            <!-- Add Student Tab -->
            <div id="addStudent" class="tab-content hidden">
                <div class="card">
                    <h2>Add New Student</h2>
                    <div class="form-group">
                        <label for="studentName">Student Name</label>
                        <input type="text" id="studentName" placeholder="Enter student name">
                    </div>
                    <div class="form-group">
                        <label for="newStudentUsername">Username</label>
                        <input type="text" id="newStudentUsername" placeholder="Enter username for student">
                    </div>
                    <div class="form-group">
                        <label for="newStudentPassword">Password</label>
                        <input type="password" id="newStudentPassword" placeholder="Enter password for student">
                    </div>
                    <button id="addStudentBtn" class="btn btn-primary">Add Student</button>
                </div>

                <div class="card">
                    <h2>Existing Students</h2>
                    <div id="studentsList" class="student-list">
                        <!-- Students will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Exam List Tab -->
            <div id="examList" class="tab-content hidden">
                <h2>My Exams</h2>
                <div id="adminExamsList" class="exam-list">
                    <!-- Exams will be listed here -->
                </div>
            </div>

            <!-- Delete Results Tab -->
            <div id="deleteResults" class="tab-content hidden">
                <h2>Delete Student Results</h2>
                <div id="resultsList" class="exam-list">
                    <!-- Results will be listed here -->
                </div>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="hidden">
            <div class="tab-container">
                <div class="tab active" data-tab="availableExams">Available Exams</div>
                <div class="tab" data-tab="myResults">My Results</div>
            </div>

            <!-- Available Exams Tab -->
            <div id="availableExams" class="tab-content">
                <h2>Available Exams</h2>
                <div id="studentExamsList" class="exam-list">
                    <!-- Available exams will be listed here -->
                </div>
            </div>

            <!-- My Results Tab -->
            <div id="myResults" class="tab-content hidden">
                <h2>My Exam Results</h2>
                <div id="studentResultsList" class="exam-list">
                    <!-- Results will be listed here -->
                </div>
            </div>
        </div>

        <!-- Exam Taking Interface -->
        <div id="examTaking" class="hidden">
            <div class="card">
                <h2 id="examTakingTitle"></h2>
                <p id="examTakingDescription"></p>
                <div id="examTimer" class="timer hidden">
                    Time Left: <span id="timeLeft">00:00</span>
                </div>
            </div>

            <div id="examQuestionsContainer">
                <!-- Exam questions will be displayed here -->
            </div>

            <div class="actions">
                <button id="submitExamBtn" class="btn btn-success">Submit Exam</button>
            </div>
        </div>

        <!-- Exam Results -->
        <div id="examResults" class="hidden">
            <div class="result-summary">
                <h2>Exam Results</h2>
                <div class="score" id="examScore">0/0</div>
                <p id="examPercentage">0%</p>
            </div>

            <div id="resultsQuestionsContainer">
                <!-- Results with correct answers will be displayed here -->
            </div>

            <div class="actions">
                <button id="backToDashboardBtn" class="btn btn-primary">Back to Dashboard</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Message -->
    <div id="confirmationMessage" class="confirmation-message hidden">
        <div class="tick">âœ“</div>
        <h3 id="confirmationTitle">Success!</h3>
        <p id="confirmationText">Operation completed successfully.</p>
        <button id="confirmationOkBtn" class="btn btn-primary">OK</button>
    </div>

    <div id="overlay" class="overlay hidden"></div>

    <script>
        // Simple localStorage-based database simulation
        const Database = {
            // Initialize with sample data if empty
            init() {
                if (!localStorage.getItem('students')) {
                    localStorage.setItem('students', JSON.stringify({}));
                }
                if (!localStorage.getItem('exams')) {
                    localStorage.setItem('exams', JSON.stringify({}));
                }
                if (!localStorage.getItem('results')) {
                    localStorage.setItem('results', JSON.stringify({}));
                }
            },

            // Student operations
            addStudent(studentData) {
                const students = JSON.parse(localStorage.getItem('students'));
                const studentId = 'student_' + Date.now();
                students[studentId] = {
                    ...studentData,
                    id: studentId,
                    createdAt: Date.now()
                };
                localStorage.setItem('students', JSON.stringify(students));
                return studentId;
            },

            getStudents() {
                return JSON.parse(localStorage.getItem('students'));
            },

            deleteStudent(studentId) {
                const students = JSON.parse(localStorage.getItem('students'));
                delete students[studentId];
                localStorage.setItem('students', JSON.stringify(students));
            },

            // Exam operations
            addExam(examData) {
                const exams = JSON.parse(localStorage.getItem('exams'));
                const examId = 'exam_' + Date.now();
                exams[examId] = {
                    ...examData,
                    id: examId,
                    createdAt: Date.now()
                };
                localStorage.setItem('exams', JSON.stringify(exams));
                return examId;
            },

            getExams() {
                return JSON.parse(localStorage.getItem('exams'));
            },

            getExam(examId) {
                const exams = JSON.parse(localStorage.getItem('exams'));
                return exams[examId];
            },

            deleteExam(examId) {
                const exams = JSON.parse(localStorage.getItem('exams'));
                delete exams[examId];
                localStorage.setItem('exams', JSON.stringify(exams));
            },

            // Result operations
            addResult(resultData) {
                const results = JSON.parse(localStorage.getItem('results'));
                const resultId = 'result_' + Date.now();
                results[resultId] = {
                    ...resultData,
                    id: resultId,
                    submittedAt: Date.now()
                };
                localStorage.setItem('results', JSON.stringify(results));
                return resultId;
            },

            getResults() {
                return JSON.parse(localStorage.getItem('results'));
            },

            getStudentResults(studentId) {
                const results = JSON.parse(localStorage.getItem('results'));
                return Object.values(results).filter(result => result.studentId === studentId);
            },

            deleteResult(resultId) {
                const results = JSON.parse(localStorage.getItem('results'));
                delete results[resultId];
                localStorage.setItem('results', JSON.stringify(results));
            }
        };

        // Initialize database
        Database.init();

        // DOM Elements
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const studentLoginBtn = document.getElementById('studentLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const studentLoginForm = document.getElementById('studentLoginForm');
        const adminDashboard = document.getElementById('adminDashboard');
        const studentDashboard = document.getElementById('studentDashboard');
        const examTaking = document.getElementById('examTaking');
        const examResults = document.getElementById('examResults');
        const currentUserName = document.getElementById('currentUserName');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationText = document.getElementById('confirmationText');
        const confirmationOkBtn = document.getElementById('confirmationOkBtn');
        const overlay = document.getElementById('overlay');

        // State variables
        let currentUser = null;
        let currentExam = null;
        let currentQuestions = [];
        let userAnswers = {};
        let currentExamId = null;
        let examTimer = null;
        let timeLeft = 0;
        let examStartTime = null;
        let examSubmitted = false;

        // Event Listeners
        adminLoginBtn.addEventListener('click', () => {
            adminLoginForm.classList.remove('hidden');
            studentLoginForm.classList.add('hidden');
        });

        studentLoginBtn.addEventListener('click', () => {
            studentLoginForm.classList.remove('hidden');
            adminLoginForm.classList.add('hidden');
        });

        document.getElementById('adminLoginSubmit').addEventListener('click', adminLogin);
        document.getElementById('studentLoginSubmit').addEventListener('click', studentLogin);
        logoutBtn.addEventListener('click', logout);

        document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
        document.getElementById('finishExamBtn').addEventListener('click', finishExam);
        document.getElementById('submitExamBtn').addEventListener('click', submitExam);
        document.getElementById('backToDashboardBtn').addEventListener('click', backToDashboard);
        document.getElementById('addStudentBtn').addEventListener('click', addStudent);
        confirmationOkBtn.addEventListener('click', hideConfirmation);

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(tabName).classList.remove('hidden');
                
                if (tabName === 'examList' && currentUser) {
                    loadAdminExams();
                } else if (tabName === 'myResults' && currentUser) {
                    loadStudentResults();
                } else if (tabName === 'availableExams' && currentUser) {
                    loadAvailableExams();
                } else if (tabName === 'addStudent' && currentUser) {
                    loadStudents();
                } else if (tabName === 'deleteResults' && currentUser) {
                    loadAllResults();
                }
            });
        });

        // Math rendering function
        function renderMath(element) {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(element, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }
        }

        // Authentication functions
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === 'admin' && password === 'admin009') {
                currentUser = {
                    uid: 'admin-uid',
                    username: 'admin',
                    role: 'admin'
                };
                updateUI();
            } else {
                alert('Invalid admin credentials. Use username: admin, password: admin009');
            }
        }

        function studentLogin() {
            const username = document.getElementById('studentUsername').value;
            const password = document.getElementById('studentPassword').value;
            
            const students = Database.getStudents();
            const student = Object.values(students).find(s => s.username === username);
            
            if (student && student.password === password) {
                currentUser = {
                    uid: student.id,
                    username: student.username,
                    name: student.name,
                    role: 'student'
                };
                updateUI();
            } else {
                alert('Invalid student credentials');
            }
        }

        function logout() {
            currentUser = null;
            if (examTimer) {
                clearInterval(examTimer);
                examTimer = null;
            }
            updateUI();
        }

        // UI Update function
        function updateUI() {
            adminLoginForm.classList.add('hidden');
            studentLoginForm.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            examTaking.classList.add('hidden');
            examResults.classList.add('hidden');
            
            if (currentUser) {
                logoutBtn.classList.remove('hidden');
                adminLoginBtn.classList.add('hidden');
                studentLoginBtn.classList.add('hidden');
                currentUserName.textContent = currentUser.name || currentUser.username;
                currentUserName.classList.remove('hidden');
                
                if (currentUser.role === 'admin') {
                    adminDashboard.classList.remove('hidden');
                    loadAdminExams();
                    loadStudents();
                    if (document.getElementById('questionsContainer').children.length === 0) {
                        addQuestion();
                    }
                } else {
                    studentDashboard.classList.remove('hidden');
                    loadAvailableExams();
                }
            } else {
                logoutBtn.classList.add('hidden');
                adminLoginBtn.classList.remove('hidden');
                studentLoginBtn.classList.remove('hidden');
                currentUserName.classList.add('hidden');
            }
        }

        // Student management functions
        function addStudent() {
            const name = document.getElementById('studentName').value;
            const username = document.getElementById('newStudentUsername').value;
            const password = document.getElementById('newStudentPassword').value;
            
            if (!name || !username || !password) {
                alert('Please fill all fields');
                return;
            }
            
            const students = Database.getStudents();
            const existingStudent = Object.values(students).find(s => s.username === username);
            
            if (existingStudent) {
                alert('Username already exists');
                return;
            }
            
            Database.addStudent({
                name: name,
                username: username,
                password: password,
                createdBy: currentUser.uid
            });
            
            showConfirmation('Student Added Successfully!', 'Student has been added successfully.');
            document.getElementById('studentName').value = '';
            document.getElementById('newStudentUsername').value = '';
            document.getElementById('newStudentPassword').value = '';
            loadStudents();
        }

        function loadStudents() {
            const students = Database.getStudents();
            const studentsList = document.getElementById('studentsList');
            const studentsForExam = document.getElementById('studentsForExam');
            
            studentsList.innerHTML = '';
            studentsForExam.innerHTML = '';
            
            if (Object.keys(students).length === 0) {
                studentsList.innerHTML = '<p>No students added yet.</p>';
                studentsForExam.innerHTML = '<p>No students available. Please add students first.</p>';
                return;
            }
            
            Object.values(students).forEach(student => {
                // For students list
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <div class="student-name">${student.name}</div>
                    <div class="student-credentials">Username: ${student.username}</div>
                    <div class="student-credentials">Password: ${student.password}</div>
                    <div class="exam-actions">
                        <button class="btn btn-danger btn-sm delete-student-btn" data-student-id="${student.id}">Delete Student</button>
                    </div>
                `;
                studentsList.appendChild(studentCard);
                
                // For students multiselect
                const studentCheckbox = document.createElement('div');
                studentCheckbox.className = 'student-checkbox';
                studentCheckbox.innerHTML = `
                    <input type="checkbox" id="student-${student.id}" value="${student.id}">
                    <label for="student-${student.id}">${student.name} (${student.username})</label>
                `;
                studentsForExam.appendChild(studentCheckbox);
            });
            
            document.querySelectorAll('.delete-student-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-student-id');
                    if (confirm('Are you sure you want to delete this student?')) {
                        deleteStudent(studentId);
                    }
                });
            });
        }

        function deleteStudent(studentId) {
            Database.deleteStudent(studentId);
            showConfirmation('Student Deleted Successfully!', 'Student has been deleted successfully.');
            loadStudents();
        }

        // Question management functions
        function addQuestion() {
            const questionsContainer = document.getElementById('questionsContainer');
            const questionCount = questionsContainer.children.length + 1;
            
            const questionHTML = `
                <div class="question-container" data-question-id="${questionCount}">
                    <div class="question-header">
                        <div class="question-number">Question ${questionCount}</div>
                        <button class="btn btn-danger remove-question-btn">Remove</button>
                    </div>
                    
                    <div class="question-category">
                        <button class="category-btn active" data-category="mcq">MCQ</button>
                        <button class="category-btn" data-category="cq">CQ</button>
                    </div>
                    
                    <div class="question-type">
                        <button class="type-btn active" data-type="text">Text</button>
                        <button class="type-btn" data-type="math">Math Equation</button>
                        <button class="type-btn" data-type="image">Image</button>
                    </div>
                    
                    <div class="form-group question-text-container">
                        <label>Question Text</label>
                        <textarea class="question-text" placeholder="Enter your question text"></textarea>
                    </div>
                    
                    <div class="form-group question-math-container hidden">
                        <label>Math Equation</label>
                        <div class="math-help">
                            <strong>Math Syntax Help:</strong>
                            <ul>
                                <li>For fractions: <code>\\frac{a}{b}</code></li>
                                <li>For square root: <code>\\sqrt{x}</code></li>
                                <li>For exponents: <code>x^{2}</code></li>
                                <li>For Greek letters: <code>\\alpha, \\beta, \\gamma</code></li>
                                <li>Use <code>$...$</code> for inline math and <code>$$...$$</code> for display math</li>
                            </ul>
                        </div>
                        <textarea class="question-math" placeholder="Enter LaTeX math equation (e.g., $E = mc^2$ or $$\\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$)"></textarea>
                        <div class="math-preview">
                            <strong>Preview:</strong>
                            <div class="math-preview-content" id="math-preview-${questionCount}"></div>
                        </div>
                    </div>
                    
                    <div class="form-group question-image-container hidden">
                        <label>Question Image</label>
                        <input type="file" class="question-image-input" accept="image/*">
                        <img class="question-image-preview" src="" alt="Question image preview" style="max-width: 100%; display: none;">
                    </div>
                    
                    <div class="mcq-options">
                        <div class="form-group">
                            <label>Options</label>
                            <div class="option">
                                <input type="text" class="option-text" placeholder="Option 1">
                                <input type="radio" name="answer-${questionCount}" value="0" class="correct-answer">
                                <span>Correct Answer</span>
                            </div>
                            <div class="option">
                                <input type="text" class="option-text" placeholder="Option 2">
                                <input type="radio" name="answer-${questionCount}" value="1" class="correct-answer">
                                <span>Correct Answer</span>
                            </div>
                            <div class="option">
                                <input type="text" class="option-text" placeholder="Option 3">
                                <input type="radio" name="answer-${questionCount}" value="2" class="correct-answer">
                                <span>Correct Answer</span>
                            </div>
                            <div class="option">
                                <input type="text" class="option-text" placeholder="Option 4">
                                <input type="radio" name="answer-${questionCount}" value="3" class="correct-answer">
                                <span>Correct Answer</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cq-answer-container hidden">
                        <div class="form-group">
                            <label>Expected Answer</label>
                            <textarea class="cq-answer" placeholder="Enter the expected answer for this CQ question"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
            
            const newQuestion = questionsContainer.lastElementChild;
            
            // Category toggle
            newQuestion.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    newQuestion.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    if (category === 'mcq') {
                        newQuestion.querySelector('.mcq-options').classList.remove('hidden');
                        newQuestion.querySelector('.cq-answer-container').classList.add('hidden');
                    } else {
                        newQuestion.querySelector('.mcq-options').classList.add('hidden');
                        newQuestion.querySelector('.cq-answer-container').classList.remove('hidden');
                    }
                });
            });
            
            // Type toggle
            newQuestion.querySelectorAll('.type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    newQuestion.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    newQuestion.querySelector('.question-text-container').classList.add('hidden');
                    newQuestion.querySelector('.question-math-container').classList.add('hidden');
                    newQuestion.querySelector('.question-image-container').classList.add('hidden');
                    
                    if (type === 'text') {
                        newQuestion.querySelector('.question-text-container').classList.remove('hidden');
                    } else if (type === 'math') {
                        newQuestion.querySelector('.question-math-container').classList.remove('hidden');
                    } else {
                        newQuestion.querySelector('.question-image-container').classList.remove('hidden');
                    }
                });
            });
            
            // Math equation preview
            const mathTextarea = newQuestion.querySelector('.question-math');
            const mathPreview = newQuestion.querySelector('.math-preview-content');
            
            mathTextarea.addEventListener('input', function() {
                mathPreview.innerHTML = this.value;
                renderMath(mathPreview);
            });
            
            const imageInput = newQuestion.querySelector('.question-image-input');
            const imagePreview = newQuestion.querySelector('.question-image-preview');
            
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            newQuestion.querySelector('.remove-question-btn').addEventListener('click', function() {
                newQuestion.remove();
                renumberQuestions();
            });
        }

        function renumberQuestions() {
            const questions = document.querySelectorAll('.question-container');
            questions.forEach((question, index) => {
                const questionNumber = index + 1;
                question.setAttribute('data-question-id', questionNumber);
                question.querySelector('.question-number').textContent = `Question ${questionNumber}`;
                
                question.querySelectorAll('.correct-answer').forEach((radio, radioIndex) => {
                    radio.setAttribute('name', `answer-${questionNumber}`);
                });
            });
        }

        function finishExam() {
            const examTitle = document.getElementById('examTitle').value;
            const examDescription = document.getElementById('examDescription').value;
            const timeLimit = parseInt(document.getElementById('examTimeLimit').value);
            
            // Get selected students
            const selectedStudents = [];
            document.querySelectorAll('#studentsForExam input[type="checkbox"]:checked').forEach(checkbox => {
                selectedStudents.push(checkbox.value);
            });
            
            if (!examTitle) {
                alert('Please enter an exam title');
                return;
            }
            
            if (selectedStudents.length === 0) {
                alert('Please select at least one student for this exam');
                return;
            }
            
            const questions = collectQuestions();
            if (questions.length === 0) {
                alert('Please add at least one question');
                return;
            }
            
            Database.addExam({
                title: examTitle,
                description: examDescription,
                timeLimit: timeLimit,
                questions: questions,
                assignedTo: selectedStudents, // Now an array of student IDs
                createdBy: currentUser.uid
            });
            
            showConfirmation('Exam Created Successfully!', 'Exam has been created and assigned to the selected students.');
            document.getElementById('examTitle').value = '';
            document.getElementById('examDescription').value = '';
            document.getElementById('examTimeLimit').value = '30';
            document.getElementById('questionsContainer').innerHTML = '';
            addQuestion();
        }

        function collectQuestions() {
            const questions = [];
            const questionContainers = document.querySelectorAll('.question-container');
            
            questionContainers.forEach(container => {
                const questionId = container.getAttribute('data-question-id');
                const category = container.querySelector('.category-btn.active').getAttribute('data-category');
                const type = container.querySelector('.type-btn.active').getAttribute('data-type');
                
                let questionData = {
                    category: category,
                    type: type
                };
                
                if (category === 'mcq') {
                    const options = [];
                    let correctAnswer = -1;
                    
                    container.querySelectorAll('.option').forEach((optionEl, index) => {
                        const optionText = optionEl.querySelector('.option-text').value;
                        options.push(optionText);
                        
                        if (optionEl.querySelector('.correct-answer').checked) {
                            correctAnswer = index;
                        }
                    });
                    
                    questionData.options = options;
                    questionData.correctAnswer = correctAnswer;
                } else {
                    // CQ question
                    questionData.expectedAnswer = container.querySelector('.cq-answer').value;
                }
                
                if (type === 'text') {
                    questionData.text = container.querySelector('.question-text').value;
                } else if (type === 'math') {
                    questionData.math = container.querySelector('.question-math').value;
                } else {
                    const imagePreview = container.querySelector('.question-image-preview');
                    if (imagePreview.style.display !== 'none') {
                        questionData.image = imagePreview.src;
                    } else {
                        questionData.image = '';
                    }
                }
                
                questions.push(questionData);
            });
            
            return questions;
        }

        // FIXED: Exam taking functions - CORRECTED VERSION
        function loadAvailableExams() {
            const exams = Database.getExams();
            const results = Database.getResults();
            const examsList = document.getElementById('studentExamsList');
            examsList.innerHTML = '';
            
            if (Object.keys(exams).length === 0) {
                examsList.innerHTML = '<p>No exams available for you.</p>';
                return;
            }
            
            // Get all exam IDs that the CURRENT student has already taken
            const takenExamIds = new Set();
            Object.values(results).forEach(result => {
                if (result.studentId === currentUser.uid) {
                    takenExamIds.add(result.examId);
                }
            });
            
            // Show exams assigned to this student
            let hasAvailableExams = false;
            
            Object.values(exams).forEach(exam => {
                // Check if this exam is assigned to this student (now assignedTo is an array)
                if (Array.isArray(exam.assignedTo) && exam.assignedTo.includes(currentUser.uid)) {
                    hasAvailableExams = true;
                    // FIX: Only check if the CURRENT student has taken this exam
                    const hasTakenExam = takenExamIds.has(exam.id);
                    
                    const examCard = document.createElement('div');
                    examCard.className = 'exam-card';
                    
                    if (hasTakenExam) {
                        // Exam already taken by THIS student - show as completed
                        examCard.innerHTML = `
                            <div class="exam-title">${exam.title}</div>
                            <div class="exam-info">${exam.description || 'No description'}</div>
                            <div class="exam-info">${exam.questions ? exam.questions.length : 0} questions</div>
                            <div class="exam-info">Time Limit: ${exam.timeLimit} minutes</div>
                            <div class="exam-actions">
                                <button class="btn btn-secondary" disabled>Already Participated</button>
                                <button class="btn btn-primary view-questions-btn" data-exam-id="${exam.id}">View Questions</button>
                            </div>
                        `;
                    } else {
                        // New exam for THIS student - show participate button
                        examCard.innerHTML = `
                            <div class="exam-title">${exam.title}</div>
                            <div class="exam-info">${exam.description || 'No description'}</div>
                            <div class="exam-info">${exam.questions ? exam.questions.length : 0} questions</div>
                            <div class="exam-info">Time Limit: ${exam.timeLimit} minutes</div>
                            <button class="btn btn-success participate-btn" data-exam-id="${exam.id}">Participate</button>
                        `;
                    }
                    
                    examsList.appendChild(examCard);
                }
            });
            
            if (!hasAvailableExams) {
                examsList.innerHTML = '<p>No exams available for you. The admin will assign exams to you.</p>';
                return;
            }
            
            // Add event listeners for participate buttons
            document.querySelectorAll('.participate-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examId = this.getAttribute('data-exam-id');
                    startExam(examId);
                });
            });
            
            // Add event listeners for view questions buttons
            document.querySelectorAll('.view-questions-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examId = this.getAttribute('data-exam-id');
                    viewExamQuestions(examId);
                });
            });
        }

        function startExam(examId) {
            const exam = Database.getExam(examId);
            if (exam) {
                currentExam = exam;
                currentExamId = examId;
                currentQuestions = exam.questions;
                userAnswers = {};
                examSubmitted = false;
                
                examStartTime = new Date();
                
                studentDashboard.classList.add('hidden');
                examTaking.classList.remove('hidden');
                
                document.getElementById('examTakingTitle').textContent = currentExam.title;
                document.getElementById('examTakingDescription').textContent = currentExam.description || '';
                
                startTimer(currentExam.timeLimit);
                displayExamQuestions();
                
                window.addEventListener('beforeunload', handleBeforeUnload);
            } else {
                alert('Exam not found');
            }
        }

        function viewExamQuestions(examId) {
            const exam = Database.getExam(examId);
            if (exam) {
                currentExam = exam;
                currentQuestions = exam.questions;
                
                const results = Database.getStudentResults(currentUser.uid);
                const result = results.find(r => r.examId === examId);
                
                if (result) {
                    userAnswers = result.answers;
                    showExamResults(result.score);
                } else {
                    alert('No result found for this exam');
                }
            } else {
                alert('Exam not found');
            }
        }

        function startTimer(minutes) {
            timeLeft = minutes * 60;
            const timerElement = document.getElementById('examTimer');
            const timeLeftElement = document.getElementById('timeLeft');
            
            timerElement.classList.remove('hidden');
            
            examTimer = setInterval(() => {
                timeLeft--;
                
                const minutesLeft = Math.floor(timeLeft / 60);
                const secondsLeft = timeLeft % 60;
                timeLeftElement.textContent = `${minutesLeft.toString().padStart(2, '0')}:${secondsLeft.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 300) {
                    timerElement.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(examTimer);
                    alert('Time is up! Your exam will be submitted automatically.');
                    submitExam();
                }
            }, 1000);
        }

        function handleBeforeUnload(e) {
            e.preventDefault();
            e.returnValue = 'If you leave this page, your exam will be submitted automatically. Are you sure?';
            return e.returnValue;
        }

        function displayExamQuestions() {
            const container = document.getElementById('examQuestionsContainer');
            container.innerHTML = '';
            
            currentQuestions.forEach((question, index) => {
                let questionContent = '';
                
                if (question.type === 'text') {
                    questionContent = `<p>${question.text}</p>`;
                } else if (question.type === 'math' && question.math) {
                    questionContent = `
                        <div class="math-equation">
                            <div class="math-content">${question.math}</div>
                        </div>
                    `;
                } else if (question.type === 'image' && question.image) {
                    questionContent = `<img src="${question.image}" alt="Question image" class="question-image">`;
                } else {
                    questionContent = '<p>[No question content]</p>';
                }
                
                let answerInput = '';
                
                if (question.category === 'mcq') {
                    answerInput = `
                        <div class="form-group">
                            ${question.options.map((option, optionIndex) => `
                                <div class="option">
                                    <input type="radio" name="answer-${index}" value="${optionIndex}" id="q${index}-opt${optionIndex}">
                                    <label for="q${index}-opt${optionIndex}">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    answerInput = `
                        <div class="form-group">
                            <label for="cq-answer-${index}">Your Answer:</label>
                            <textarea id="cq-answer-${index}" class="cq-answer-field" placeholder="Type your answer here..."></textarea>
                        </div>
                    `;
                }
                
                const questionHTML = `
                    <div class="card">
                        <div class="question-number">Question ${index + 1} (${question.category === 'mcq' ? 'MCQ' : 'CQ'})</div>
                        ${questionContent}
                        ${answerInput}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', questionHTML);
                
                const questionElement = container.lastElementChild;
                
                if (question.category === 'mcq') {
                    questionElement.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            userAnswers[index] = parseInt(this.value);
                        });
                    });
                } else {
                    const textarea = questionElement.querySelector('.cq-answer-field');
                    textarea.addEventListener('input', function() {
                        userAnswers[index] = this.value;
                    });
                }
            });
            
            // Render math equations after adding to DOM
            renderMath(container);
        }

        function submitExam() {
            if (examSubmitted) {
                alert('Exam already submitted!');
                return;
            }
            
            window.removeEventListener('beforeunload', handleBeforeUnload);
            
            if (examTimer) {
                clearInterval(examTimer);
                examTimer = null;
            }
            
            document.getElementById('examTimer').classList.add('hidden');
            document.getElementById('submitExamBtn').disabled = true;
            
            // For MCQ questions, check if all are answered
            const unansweredMcq = currentQuestions
                .map((question, index) => ({question, index}))
                .filter(({question, index}) => 
                    question.category === 'mcq' && userAnswers[index] === undefined
                );
            
            if (unansweredMcq.length > 0) {
                if (!confirm(`You have ${unansweredMcq.length} unanswered MCQ questions. Submit anyway?`)) {
                    startTimer(Math.ceil(timeLeft / 60));
                    window.addEventListener('beforeunload', handleBeforeUnload);
                    document.getElementById('submitExamBtn').disabled = false;
                    return;
                }
            }
            
            let score = 0;
            currentQuestions.forEach((question, index) => {
                if (question.category === 'mcq') {
                    if (userAnswers[index] === question.correctAnswer) {
                        score++;
                    }
                }
                // For CQ questions, we don't auto-score, just record the answer
            });
            
            Database.addResult({
                examId: currentExamId,
                examTitle: currentExam.title,
                studentId: currentUser.uid,
                studentName: currentUser.name,
                studentUsername: currentUser.username,
                answers: userAnswers,
                score: score,
                totalQuestions: currentQuestions.length,
                timeSpent: (currentExam.timeLimit * 60) - timeLeft
            });
            
            examSubmitted = true;
            
            // Show results immediately
            showExamResults(score);
        }

        function showExamResults(score) {
            examTaking.classList.add('hidden');
            examResults.classList.remove('hidden');
            
            document.getElementById('examScore').textContent = `${score}/${currentQuestions.length}`;
            const percentage = Math.round((score / currentQuestions.length) * 100);
            document.getElementById('examPercentage').textContent = `${percentage}%`;
            
            const container = document.getElementById('resultsQuestionsContainer');
            container.innerHTML = '';
            
            currentQuestions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                let answerDisplay = '';
                
                if (question.category === 'mcq') {
                    isCorrect = userAnswer === question.correctAnswer;
                    answerDisplay = userAnswer !== undefined ? 
                        question.options[userAnswer] : 'Not answered';
                } else {
                    // For CQ questions, we just display the answer
                    answerDisplay = userAnswer || 'Not answered';
                }
                
                let questionContent = '';
                
                if (question.type === 'text') {
                    questionContent = `<p>${question.text}</p>`;
                } else if (question.type === 'math' && question.math) {
                    questionContent = `
                        <div class="math-equation">
                            <div class="math-content">${question.math}</div>
                        </div>
                    `;
                } else if (question.type === 'image' && question.image) {
                    questionContent = `<img src="${question.image}" alt="Question image" class="question-image">`;
                } else {
                    questionContent = '<p>[No question content]</p>';
                }
                
                const questionHTML = `
                    <div class="card ${question.category === 'mcq' ? (isCorrect ? 'correct-answer' : 'incorrect-answer') : ''}">
                        <div class="question-number">Question ${index + 1} (${question.category === 'mcq' ? 'MCQ' : 'CQ'})</div>
                        ${questionContent}
                        <div class="student-answer">
                            <strong>Your answer:</strong> 
                            ${answerDisplay}
                            ${question.category === 'mcq' ? (isCorrect ? ' âœ“' : ' âœ—') : ''}
                        </div>
                        ${question.category === 'mcq' ? `
                            <div class="correct-answer">
                                <strong>Correct answer:</strong> ${question.options[question.correctAnswer]}
                            </div>
                        ` : ''}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', questionHTML);
            });
            
            // Render math equations after adding to DOM
            renderMath(container);
        }

        function backToDashboard() {
            examResults.classList.add('hidden');
            studentDashboard.classList.remove('hidden');
            // Refresh the available exams list to reflect the completed exam
            loadAvailableExams();
        }

        // Admin functions
        function loadAdminExams() {
            const exams = Database.getExams();
            const examsList = document.getElementById('adminExamsList');
            examsList.innerHTML = '';
            
            if (Object.keys(exams).length === 0) {
                examsList.innerHTML = '<p>You haven\'t created any exams yet.</p>';
                return;
            }
            
            Object.values(exams).forEach(exam => {
                if (exam.createdBy === currentUser.uid) {
                    const examCard = document.createElement('div');
                    examCard.className = 'exam-card';
                    
                    // Get student names for display
                    const students = Database.getStudents();
                    const assignedStudents = Array.isArray(exam.assignedTo) ? 
                        exam.assignedTo.map(id => students[id]?.name || 'Unknown').join(', ') : 
                        'No students assigned';
                    
                    examCard.innerHTML = `
                        <div class="exam-title">${exam.title}</div>
                        <div class="exam-info">${exam.description || 'No description'}</div>
                        <div class="exam-info">${exam.questions ? exam.questions.length : 0} questions</div>
                        <div class="exam-info">Time Limit: ${exam.timeLimit} minutes</div>
                        <div class="exam-info">Assigned to: ${assignedStudents}</div>
                        <div class="exam-actions">
                            <button class="btn btn-danger btn-sm delete-exam-btn" data-exam-id="${exam.id}">Delete Exam</button>
                        </div>
                    `;
                    examsList.appendChild(examCard);
                }
            });
            
            document.querySelectorAll('.delete-exam-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const examId = this.getAttribute('data-exam-id');
                    if (confirm('Are you sure you want to delete this exam? This will also remove it from the student\'s dashboard.')) {
                        deleteExam(examId);
                    }
                });
            });
        }

        function deleteExam(examId) {
            Database.deleteExam(examId);
            
            // Also delete related results
            const results = Database.getResults();
            Object.keys(results).forEach(resultId => {
                if (results[resultId].examId === examId) {
                    Database.deleteResult(resultId);
                }
            });
            
            showConfirmation('Exam Deleted Successfully!', 'Exam has been deleted successfully.');
            loadAdminExams();
        }

        function loadAllResults() {
            const results = Database.getResults();
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            if (Object.keys(results).length === 0) {
                resultsList.innerHTML = '<p>No results found.</p>';
                return;
            }
            
            Object.values(results).forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'exam-card';
                resultCard.innerHTML = `
                    <div class="exam-title">${result.examTitle}</div>
                    <div class="exam-info">Student: ${result.studentName} (${result.studentUsername})</div>
                    <div class="exam-info">Score: ${result.score}/${result.totalQuestions}</div>
                    <div class="exam-info">Percentage: ${Math.round((result.score / result.totalQuestions) * 100)}%</div>
                    <div class="exam-info">Submitted: ${new Date(result.submittedAt).toLocaleDateString()}</div>
                    <div class="exam-actions">
                        <button class="btn btn-danger btn-sm delete-result-btn" data-result-id="${result.id}">Delete Result</button>
                    </div>
                `;
                resultsList.appendChild(resultCard);
            });
            
            document.querySelectorAll('.delete-result-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const resultId = this.getAttribute('data-result-id');
                    if (confirm('Are you sure you want to delete this result? This will also remove it from the student\'s dashboard.')) {
                        deleteResult(resultId);
                    }
                });
            });
        }

        function deleteResult(resultId) {
            Database.deleteResult(resultId);
            showConfirmation('Result Deleted Successfully!', 'Result has been deleted successfully.');
            loadAllResults();
        }

        function loadStudentResults() {
            const results = Database.getStudentResults(currentUser.uid);
            const resultsList = document.getElementById('studentResultsList');
            resultsList.innerHTML = '';
            
            if (results.length === 0) {
                resultsList.innerHTML = '<p>You haven\'t taken any exams yet.</p>';
                return;
            }
            
            results.forEach(result => {
                const resultCard = document.createElement('div');
                resultCard.className = 'exam-card';
                resultCard.innerHTML = `
                    <div class="exam-title">${result.examTitle}</div>
                    <div class="exam-info">Score: ${result.score}/${result.totalQuestions}</div>
                    <div class="exam-info">Percentage: ${Math.round((result.score / result.totalQuestions) * 100)}%</div>
                    <div class="exam-info">Submitted: ${new Date(result.submittedAt).toLocaleDateString()}</div>
                `;
                resultsList.appendChild(resultCard);
                
                // Add click event to show results when clicking on the result card
                resultCard.addEventListener('click', function() {
                    viewResultDetails(result.id);
                });
                resultCard.style.cursor = 'pointer';
                resultCard.style.transition = 'all 0.3s ease';
                
                resultCard.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.15)';
                });
                
                resultCard.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'var(--shadow)';
                });
            });
        }

        function viewResultDetails(resultId) {
            const results = Database.getResults();
            const result = results[resultId];
            
            if (result) {
                const exam = Database.getExam(result.examId);
                if (exam) {
                    currentExam = exam;
                    currentQuestions = exam.questions;
                    userAnswers = result.answers;
                    
                    showExamResults(result.score);
                } else {
                    alert('Exam details not found');
                }
            } else {
                alert('Result not found');
            }
        }

        // Utility functions
        function showConfirmation(title, text) {
            confirmationTitle.textContent = title;
            confirmationText.textContent = text;
            confirmationMessage.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            confirmationOkBtn.onclick = function() {
                hideConfirmation();
            };
        }

        function hideConfirmation() {
            confirmationMessage.classList.add('hidden');
            overlay.classList.add('hidden');
        }

        // Initialize the app
        updateUI();
    </script>
</body>
</html>
